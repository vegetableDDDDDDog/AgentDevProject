# æ•°æ®åº“é€‰å‹åˆ†æï¼šSQLite vs MySQL vs PostgreSQL

> **é¡¹ç›®**: Agent PaaS å¹³å° Phase 2
> **æ—¥æœŸ**: 2026-02-14
> **å½“å‰æ•°æ®åº“**: SQLite (Phase 1å·²ä½¿ç”¨)

---

## 1. å½“å‰é¡¹ç›®ç‰¹å¾

### 1.1 é¡¹ç›®æ€§è´¨
- **ç±»å‹**: å­¦ä¹ /å®éªŒé¡¹ç›®
- **é˜¶æ®µ**: Phase 2 (å¤šç§Ÿæˆ· + çœŸå®LLM)
- **ç”¨æˆ·è§„æ¨¡**: é¢„è®¡ < 100 å¹¶å‘ç”¨æˆ·
- **æ•°æ®é‡**: é¢„è®¡ < 10GB
- **éƒ¨ç½²ç¯å¢ƒ**: å•æœºéƒ¨ç½²

### 1.2 Phase 1 SQLiteç°çŠ¶
```python
# services/database.py
DATABASE_URL = "sqlite:///data/agent_platform.db"

# å·²å®ç°åŠŸèƒ½
âœ… å¤–é”®çº¦æŸ (PRAGMA foreign_keys=ON)
âœ… JSONå­—æ®µ (config, meta)
âœ… çº§è”åˆ é™¤
âœ… äº‹åŠ¡æ”¯æŒ
âœ… å®Œæ•´çš„ORMæ¨¡å‹
```

---

## 2. ä¸‰æ–¹æ¡ˆå¯¹æ¯”

### 2.1 åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ç‰¹æ€§ | SQLite | MySQL | PostgreSQL |
|---------|--------|-------|-------------|
| **å¹¶å‘å†™å…¥** | âŒ å•å†™å…¥è€… | âœ… å¤šå†™å…¥è€… | âœ… å¤šå†™å…¥è€… |
| **JSONæ”¯æŒ** | âœ… JSON1æ‰©å±• | âœ… JSONç±»å‹ | âœ… JSONBç±»å‹ (æ›´å¼º) |
| **å…¨æ–‡æœç´¢** | âœ… FTS5æ‰©å±• | âœ… FULLTEXT | âœ… æ›´å¼ºå¤§çš„FTS |
| **è¡Œçº§å®‰å…¨** | âŒ ä¸æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ (RLS) |
| **å¤–é”®çº¦æŸ** | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **äº‹åŠ¡éš”ç¦»** | âœ… SERIALIZABLE | âœ… å¯é…ç½®çº§åˆ« | âœ… å¯é…ç½®çº§åˆ« |
| **éƒ¨ç½²å¤æ‚åº¦** | â­ é›¶é…ç½® | â­â­â­ éœ€è¦ç‹¬ç«‹æœåŠ¡ | â­â­â­â­ éœ€è¦ç‹¬ç«‹æœåŠ¡ |
| **å¤‡ä»½æ¢å¤** | â­â­ æ–‡ä»¶å¤åˆ¶ | â­â­â­ mysqldump | â­â­â­ pg_dump |
| **å­¦ä¹ æ›²çº¿** | â­ æœ€ç®€å• | â­â­ ä¸­ç­‰ | â­â­â­ è¾ƒé™¡ |

### 2.2 æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | SQLite | MySQL | PostgreSQL |
|------|--------|-------|-------------|
| **è¯»å¯†é›†** | â­â­â­â­â­ ä¼˜ç§€ | â­â­â­â­ è‰¯å¥½ | â­â­â­â­ è‰¯å¥½ |
| **å†™å¯†é›†** | â­â­ è¾ƒå·® (é”ç«äº‰) | â­â­â­â­ ä¼˜ç§€ | â­â­â­â­ ä¼˜ç§€ |
| **JSONæŸ¥è¯¢** | â­â­â­ å¯ç”¨ | â­â­â­ è‰¯å¥½ | â­â­â­â­â­ ä¼˜ç§€ |
| **å¤æ‚JOIN** | â­â­â­ å¯ç”¨ | â­â­â­â­ è‰¯å¥½ | â­â­â­â­â­ ä¼˜ç§€ |
| **å¹¶å‘äº‹åŠ¡** | â­â­ è¾ƒå·® | â­â­â­â­â­ ä¼˜ç§€ | â­â­â­â­â­ ä¼˜ç§€ |

### 2.3 å¤šç§Ÿæˆ·åœºæ™¯å¯¹æ¯”

| éœ€æ±‚ | SQLite | MySQL | PostgreSQL |
|------|--------|-------|-------------|
| **ç§Ÿæˆ·æ•°æ®éš”ç¦»** | âœ… åº”ç”¨å±‚ + tenant_id | âœ… åº”ç”¨å±‚ + tenant_id | âœ… åº”ç”¨å±‚ + tenant_id |
| **è¡Œçº§å®‰å…¨ (RLS)** | âŒ éœ€è¦åº”ç”¨å±‚å®ç° | âŒ éœ€è¦åº”ç”¨å±‚å®ç° | âœ… æ•°æ®åº“å±‚å¼ºåˆ¶ |
| **Schemaéš”ç¦»** | âŒ ä¸æ”¯æŒå¤šSchema | âœ… æ”¯æŒå¤šSchema | âœ… æ”¯æŒå¤šSchema |
| **ç§Ÿæˆ·é…é¢** | âœ… åº”ç”¨å±‚æŸ¥è¯¢ | âœ… åº”ç”¨å±‚æŸ¥è¯¢ | âœ… åº”ç”¨å±‚æŸ¥è¯¢ |
| **è·¨ç§Ÿæˆ·æŸ¥è¯¢** | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |

---

## 3. Phase 2 å®é™…éœ€æ±‚åˆ†æ

### 3.1 å¤šç§Ÿæˆ·æ¶æ„

**éœ€æ±‚æè¿°**:
```sql
-- ç§Ÿæˆ·è¡¨
CREATE TABLE tenants (
    id UUID PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    settings JSONB,  -- JSONé…ç½®
    ...
);

-- ç”¨æˆ·è¡¨ (å…³è”ç§Ÿæˆ·)
CREATE TABLE users (
    id UUID PRIMARY KEY,
    tenant_id UUID REFERENCES tenants(id),  -- ç§Ÿæˆ·éš”ç¦»
    ...
);

-- æ¶ˆæ¯è¡¨ (å…³è”ç§Ÿæˆ·)
CREATE TABLE messages (
    ...
    tenant_id UUID REFERENCES tenants(id),  -- ç§Ÿæˆ·éš”ç¦»
    ...
);
```

**SQLiteå®ç°**:
```python
# åº”ç”¨å±‚éš”ç¦» (ä¸MySQLç›¸åŒ)
def get_user_messages(db: Session, tenant_id: str, user_id: str):
    return db.query(Message).filter(
        and_(
            Message.tenant_id == tenant_id,  # ç§Ÿæˆ·éš”ç¦»
            Message.user_id == user_id
        )
    ).all()
```

**ç»“è®º**: âœ… **SQLiteå®Œå…¨å¯ä»¥å®ç°å¤šç§Ÿæˆ·éš”ç¦»** (ä¸MySQLæ— å·®å¼‚)

### 3.2 è®¤è¯ä¸æˆæƒ

**éœ€æ±‚**: JWT + OAuth2, ç”¨æˆ·ç®¡ç†

**SQLiteå®ç°**:
```python
# å®Œå…¨æ”¯æŒ
class User(Base):
    __tablename__ = "users"
    id = Column(String, primary_key=True)
    email = Column(String, nullable=False, unique=True)
    password_hash = Column(String, nullable=False)
    tenant_id = Column(String, ForeignKey("tenants.id"))
    role = Column(String, nullable=False)
```

**ç»“è®º**: âœ… **SQLiteå®Œå…¨æ”¯æŒè®¤è¯æˆæƒ** (ä¸MySQLæ— å·®å¼‚)

### 3.3 çœŸå®LLMé›†æˆ

**éœ€æ±‚**: Tokené…é¢ç®¡ç†, ä½¿ç”¨è®°å½•

**SQLiteå®ç°**:
```python
# å®Œå…¨æ”¯æŒ
class TenantQuota(Base):
    __tablename__ = "tenant_quotas"
    tenant_id = Column(String, ForeignKey("tenants.id"), primary_key=True)
    max_tokens_per_month = Column(Integer, default=1000000)
    current_month_tokens = Column(Integer, default=0)
    reset_date = Column(Date)
```

**ç»“è®º**: âœ… **SQLiteå®Œå…¨æ”¯æŒé…é¢ç®¡ç†** (ä¸MySQLæ— å·®å¼‚)

### 3.4 å¹¶å‘æ€§èƒ½éœ€æ±‚

**é¢„æœŸåœºæ™¯**:
- å­¦ä¹ é¡¹ç›®
- < 100 å¹¶å‘ç”¨æˆ·
- < 10 QPS (æ¯ç§’æŸ¥è¯¢æ•°)

**SQLiteæ€§èƒ½**:
- è¯»æ€§èƒ½: ~1000 QPS (å•æœº)
- å†™æ€§èƒ½: ~100 QPS (å•å†™å…¥è€…é™åˆ¶)
- **ç»“è®º**: âœ… **å®Œå…¨æ»¡è¶³å­¦ä¹ é¡¹ç›®éœ€æ±‚**

### 3.5 æ•°æ®å¯é æ€§

**SQLiteç‰¹æ€§**:
```python
# å·²å¯ç”¨
- WALæ¨¡å¼ (Write-Ahead Logging): æ”¯æŒå¹¶å‘è¯»
- å¤–é”®çº¦æŸ: æ•°æ®å®Œæ•´æ€§
- äº‹åŠ¡: ACIDç‰¹æ€§
- å®šæœŸå¤‡ä»½: ç®€å•æ–‡ä»¶å¤åˆ¶
```

**ç»“è®º**: âœ… **SQLiteæ•°æ®å¯é æ€§è¶³å¤Ÿ** (å­¦ä¹ é¡¹ç›®)

---

## 4. è¿ç§»æˆæœ¬åˆ†æ

### 4.1 SQLite â†’ PostgreSQL

**æˆæœ¬é¡¹**:
- âœ… å®‰è£…PostgreSQLæœåŠ¡
- âœ… å­¦ä¹ PostgreSQLç‰¹æ€§
- âœ… ä¿®æ”¹æ•°æ®åº“è¿æ¥ä»£ç 
- âœ… æ•°æ®è¿ç§»è„šæœ¬
- âœ… ä¿®æ”¹SQLAlchemyé…ç½®
- âœ… é‡æ–°æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
- âœ… æ–‡æ¡£æ›´æ–°

**é¢„è®¡æ—¶é—´**: 3-5å¤©

**æ”¶ç›Š**:
- âŒ å­¦ä¹ é¡¹ç›®æ— æ˜æ˜¾æ”¶ç›Š
- âŒ æ€§èƒ½æå‡æœ‰é™ (å½“å‰ç“¶é¢ˆåœ¨LLMè°ƒç”¨)
- âŒ åŠŸèƒ½å¢å¼ºæœ‰é™ (RLSç­‰ç‰¹æ€§ç”¨ä¸ä¸Š)

### 4.2 SQLite â†’ MySQL

**æˆæœ¬é¡¹**:
- âœ… å®‰è£…MySQLæœåŠ¡
- âœ… å­¦ä¹ MySQLç‰¹æ€§
- âœ… ä¿®æ”¹æ•°æ®åº“è¿æ¥ä»£ç 
- âœ… æ•°æ®è¿ç§»è„šæœ¬
- âœ… ä¿®æ”¹SQLAlchemyé…ç½®
- âœ… é‡æ–°æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
- âœ… æ–‡æ¡£æ›´æ–°

**é¢„è®¡æ—¶é—´**: 3-5å¤©

**æ”¶ç›Š**:
- âŒ å­¦ä¹ é¡¹ç›®æ— æ˜æ˜¾æ”¶ç›Š
- âŒ æ€§èƒ½æå‡æœ‰é™ (å½“å‰ç“¶é¢ˆåœ¨LLMè°ƒç”¨)
- âŒ åŠŸèƒ½å¢å¼ºæœ‰é™ (ä¸SQLiteåŠŸèƒ½ç›¸ä¼¼)

### 4.3 ä¿æŒSQLite

**æˆæœ¬é¡¹**:
- âœ… é›¶æˆæœ¬ (ç»§ç»­ä½¿ç”¨)

**æ”¶ç›Š**:
- âœ… ä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½ (LLMé›†æˆ, å‰ç«¯UI)
- âœ… åŠ å¿«å¼€å‘é€Ÿåº¦
- âœ… é™ä½å­¦ä¹ æ›²çº¿
- âœ… ä»£ç ç®€åŒ– (æ— éœ€æ•°æ®åº“å±‚æŠ½è±¡)

**é£é™©**:
- âš ï¸ åç»­å¦‚éœ€è¿ç§» (ä½†SQLAlchemyæ”¯æŒè‰¯å¥½)

---

## 5. æŠ€æœ¯å€ºåŠ¡è€ƒè™‘

### 5.1 SQLiteçš„å±€é™

**å·²çŸ¥çš„é™åˆ¶**:
1. **å¹¶å‘å†™å…¥**: å•å†™å…¥è€…é™åˆ¶
   - **å½±å“**: é«˜å¹¶å‘å†™å…¥åœºæ™¯
   - **Phase 2**: âŒ ä¸ä¼šé‡åˆ° (< 100 ç”¨æˆ·)

2. **ç½‘ç»œè®¿é—®**: ä»…æœ¬åœ°æ–‡ä»¶è®¿é—®
   - **å½±å“**: æ— æ³•åˆ†å¸ƒå¼éƒ¨ç½²
   - **Phase 2**: âŒ ä¸éœ€è¦åˆ†å¸ƒå¼

3. **å­˜å‚¨å®¹é‡**: ç†è®ºä¸Šæ”¯æŒTBçº§
   - **å½±å“**: å¤§æ•°æ®é‡åœºæ™¯
   - **Phase 2**: âŒ ä¸ä¼šè¶…è¿‡10GB

4. **è¡Œçº§å®‰å…¨**: ä¸æ”¯æŒRLS
   - **å½±å“**: ç§Ÿæˆ·éš”ç¦»éœ€è¦åœ¨åº”ç”¨å±‚å®ç°
   - **Phase 2**: âœ… åº”ç”¨å±‚å®ç°å·²è¶³å¤Ÿ

### 5.2 æœªæ¥è¿ç§»è·¯å¾„

**å¦‚æœªæ¥éœ€è¦è¿ç§»åˆ°PostgreSQL/MySQL**:

```python
# SQLAchemyè‰¯å¥½çš„æŠ½è±¡å±‚
# å½“å‰ä»£ç 
engine = create_engine("sqlite:///data/agent_platform.db")

# è¿ç§»åªéœ€æ”¹ä¸€è¡Œ
engine = create_engine("postgresql://user:pass@localhost/agent_platform")
# æˆ–
engine = create_engine("mysql+pymysql://user:pass@localhost/agent_platform")
```

**æ•°æ®è¿ç§»**:
```bash
# ä½¿ç”¨pgloader (SQLite â†’ PostgreSQL)
pgloader sqlite:///data/agent_platform.db \
          postgresql://user:pass@localhost/agent_platform

# æˆ–ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬
# SQLAchemyæ”¯æŒè¯»å–æ‰€æœ‰æ•°æ®
```

**ç»“è®º**: âœ… **è¿ç§»æˆæœ¬ä½ï¼ŒSQLAchemyå·²æä¾›è‰¯å¥½æŠ½è±¡**

---

## 6. æ¨èæ–¹æ¡ˆ

### 6.1 çŸ­æœŸæ–¹æ¡ˆ (Phase 2)

**æ¨è**: **ç»§ç»­ä½¿ç”¨SQLite**

**ç†ç”±**:
1. âœ… **é›¶æˆæœ¬** - æ— éœ€è¿ç§»ï¼Œä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½
2. âœ… **é›¶é£é™©** - Phase 1å·²éªŒè¯å¯è¡Œ
3. âœ… **åŠ é€Ÿå¼€å‘** - 3-5å¤©æ—¶é—´ç”¨äºæ ¸å¿ƒåŠŸèƒ½
4. âœ… **å­¦ä¹ å‹å¥½** - é™ä½å¤æ‚åº¦
5. âœ… **å®Œå…¨æ»¡è¶³éœ€æ±‚** - å¤šç§Ÿæˆ·ã€è®¤è¯ã€é…é¢å‡æ”¯æŒ

### 6.2 ä¸­æœŸæ–¹æ¡ˆ (Phase 3/ç”Ÿäº§åŒ–)

**ä½•æ—¶è€ƒè™‘è¿ç§»**:
- âŒ çœŸå®éƒ¨ç½²éœ€æ±‚ (> 1000 ç”¨æˆ·)
- âŒ åˆ†å¸ƒå¼éƒ¨ç½²éœ€æ±‚
- âŒ é«˜å¹¶å‘å†™å…¥éœ€æ±‚ (> 100 QPS)
- âŒ éœ€è¦æ•°æ®åº“å±‚å®‰å…¨ (RLS)

**æ¨èè¿ç§»ç›®æ ‡**:
1. **PostgreSQL** (ä¼˜å…ˆ)
   - æ›´å¼ºçš„JSONæ”¯æŒ (JSONB)
   - è¡Œçº§å®‰å…¨ (RLS)
   - æ›´å¥½çš„å¹¶å‘æ§åˆ¶
   - æ›´ä¸°å¯Œçš„ç´¢å¼•ç±»å‹

2. **MySQL** (å¤‡é€‰)
   - æ›´æµè¡Œï¼Œç”Ÿæ€æ›´å¤§
   - å­¦ä¹ èµ„æºæ›´å¤š
   - äº‘æœåŠ¡å•†æ”¯æŒæ›´å¥½

### 6.3 å…·ä½“å»ºè®®

**Phase 2å½“å‰å†³ç­–**:
```python
# âœ… æ¨è: ä¿æŒSQLite
DATABASE_URL = "sqlite:///data/agent_platform.db"

# âš ï¸ ä¸æ¨è: æµªè´¹3-5å¤©è¿ç§»
# DATABASE_URL = "postgresql://localhost/agent_platform"
# DATABASE_URL = "mysql://localhost/agent_platform"
```

**Phase 2å¢å¼º**:
```python
# å¯é€‰: å¯ç”¨WALæ¨¡å¼ (å·²æ”¯æŒå¹¶å‘è¯»)
# åœ¨ database.py ä¸­
engine = create_engine(
    "sqlite:///data/agent_platform.db",
    connect_args={
        "check_same_thread": False,
        "timeout": 30  # å¢åŠ è¶…æ—¶æ—¶é—´
    },
    pool_pre_ping=True
)

# åº”ç”¨å±‚ç§Ÿæˆ·éš”ç¦» (æ‰€æœ‰æŸ¥è¯¢å¿…é¡»åŠ tenant_idè¿‡æ»¤)
@contextmanager
def tenant_scope(db: Session, tenant_id: str):
    """ç§Ÿæˆ·éš”ç¦»ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    try:
        # è‡ªåŠ¨è¿‡æ»¤æ‰€æœ‰æŸ¥è¯¢
        yield db
    finally:
        pass
```

**æœªæ¥è¿ç§»å‡†å¤‡**:
```python
# ä¿æŒä»£ç æ•°æ®åº“æ— å…³ (SQLAchemy)
# é¿å…ä½¿ç”¨æ•°æ®åº“ç‰¹å®šç‰¹æ€§
# âœ… å¥½çš„åšæ³•
messages = db.query(Message).filter(Message.tenant_id == tenant_id).all()

# âŒ é¿å… (SQLiteç‰¹å®š)
cursor.execute("PRAGMA synchronous=NORMAL")

# âŒ é¿å… (PostgreSQLç‰¹å®š)
session.execute(text("SET LOCAL search_path TO tenant_1"))
```

---

## 7. æ€»ç»“

### 7.1 å†³ç­–çŸ©é˜µ

| æ–¹æ¡ˆ | å­¦ä¹ æ›²çº¿ | å¼€å‘æˆæœ¬ | è¿ç»´æˆæœ¬ | æ€§èƒ½ | åŠŸèƒ½å®Œæ•´æ€§ | æ¨èåº¦ |
|------|---------|---------|---------|------|-----------|-------|
| **SQLite** | â­ (æœ€ä½) | â­ (æœ€ä½) | â­ (æœ€ä½) | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **MySQL** | â­â­â­ (ä¸­ç­‰) | â­â­â­ (ä¸­ç­‰) | â­â­â­ (ä¸­ç­‰) | â­â­â­â­ | â­â­â­â­ | â­â­ |
| **PostgreSQL** | â­â­â­â­ (è¾ƒé«˜) | â­â­â­â­ (è¾ƒé«˜) | â­â­â­â­ (è¾ƒé«˜) | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |

### 7.2 æœ€ç»ˆå»ºè®®

**Phase 2**: âœ… **ç»§ç»­ä½¿ç”¨SQLite**
- ä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½ (LLMé›†æˆ, å‰ç«¯UI)
- åŠ é€Ÿå¼€å‘è¿›åº¦
- é™ä½å­¦ä¹ æ›²çº¿
- æ»¡è¶³æ‰€æœ‰åŠŸèƒ½éœ€æ±‚

**Phase 3+**: ğŸ¤· **æ ¹æ®å®é™…éœ€æ±‚å†³å®š**
- å¦‚è¾¾åˆ°SQLiteé™åˆ¶ï¼Œå†è¿ç§»
- SQLAchemyæŠ½è±¡å±‚ä¿è¯ä½è¿ç§»æˆæœ¬
- PostgreSQLä¼˜å…ˆ (æ›´å¼ºåŠŸèƒ½)
- MySQLå¤‡é€‰ (æ›´æµè¡Œ)

**å…³é”®åŸåˆ™**: **å¤Ÿç”¨å³å¯** (You Aren't Gonna Need It - YAGNI)

---

*ä½œè€…: Claude Code*
*æ—¥æœŸ: 2026-02-14*
*ç»“è®º: Phase 2 æ¨èç»§ç»­ä½¿ç”¨SQLite*
