# â“ å¸¸è§é—®é¢˜è§£ç­”

> é—®é¢˜æ’æŸ¥å’Œè§£å†³æ–¹æ¡ˆ

---

## ğŸ“‹ ç›®å½•

1. [ç¯å¢ƒé…ç½®é—®é¢˜](#ç¯å¢ƒé…ç½®é—®é¢˜)
2. [API è°ƒç”¨é—®é¢˜](#api-è°ƒç”¨é—®é¢˜)
3. [åŠŸèƒ½ä½¿ç”¨é—®é¢˜](#åŠŸèƒ½ä½¿ç”¨é—®é¢˜)
4. [æ€§èƒ½ä¼˜åŒ–é—®é¢˜](#æ€§èƒ½ä¼˜åŒ–é—®é¢˜)
5. [å…¶ä»–é—®é¢˜](#å…¶ä»–é—®é¢˜)

---

## ğŸ”§ ç¯å¢ƒé…ç½®é—®é¢˜

### Q1: ImportError: No module named 'langchain'

**é”™è¯¯ä¿¡æ¯ï¼š**
```
ImportError: No module named 'langchain'
```

**åŸå› ï¼š** æœªå®‰è£…ä¾èµ–æˆ–ç¯å¢ƒä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ Python ç¯å¢ƒ
python --version

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# éªŒè¯å®‰è£…
python -c "import langchain; print(langchain.__version__)"
```

### Q2: æ‰¾ä¸åˆ° .env æ–‡ä»¶

**é”™è¯¯ä¿¡æ¯ï¼š**
```
FileNotFoundError: .env file not found
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. ç¡®è®¤ .env æ–‡ä»¶å­˜åœ¨
ls -la .env

# 2. å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
cp .env.example .env  # å¦‚æœæœ‰ç¤ºä¾‹æ–‡ä»¶

# 3. ç¼–è¾‘ .env å¡«å…¥ API Key
nano .env
```

### Q3: Python ç‰ˆæœ¬ä¸å…¼å®¹

**é”™è¯¯ä¿¡æ¯ï¼š**
```
SyntaxError: invalid syntax (Python 2.x)
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# éœ€è¦ Python 3.9+
python3 --version

# ä½¿ç”¨æ­£ç¡®çš„ Python ç‰ˆæœ¬
python3 agent.py

# æˆ–åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ–
venv\Scripts\activate  # Windows
```

---

## ğŸŒ API è°ƒç”¨é—®é¢˜

### Q4: null value for 'choices'

**é”™è¯¯ä¿¡æ¯ï¼š**
```
APIError: null value for 'choices' column violates constraint
```

**åŸå› ï¼š** API_BASE é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ .env æ–‡ä»¶
OPENAI_API_BASE=https://open.bigmodel.cn/api/paas/v4/
```

**å¸¸è§é”™è¯¯é…ç½®ï¼š**
- âŒ `https://open.bigmodel.cn/api/anthropic`
- âŒ `https://api.openai.com/v1`
- âœ… `https://open.bigmodel.cn/api/paas/v4/`

### Q5: Error code: 429 (é€Ÿç‡é™åˆ¶)

**é”™è¯¯ä¿¡æ¯ï¼š**
```
openai.RateLimitError: Error code: 429
```

**åŸå› ï¼š** API è°ƒç”¨é¢‘ç‡è¶…é™

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ–¹æ¡ˆ 1: æ·»åŠ å»¶è¿Ÿ
import time

def query_with_retry(question):
    try:
        return agent.query(question)
    except Exception as e:
        if "429" in str(e):
            time.sleep(60)  # ç­‰å¾… 1 åˆ†é’Ÿ
            return agent.query(question)
        raise

# æ–¹æ¡ˆ 2: ä½¿ç”¨é‡è¯•è£…é¥°å™¨
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(stop=stop_after_attempt(3), wait=wait_exponential(min=2, max=10))
def llm_call(prompt):
    return llm.invoke(prompt)
```

### Q6: æ¨¡å‹ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯ï¼š**
```
BadRequestError: æ¨¡å‹ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ¨¡å‹ä»£ç 
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥æ¨¡å‹åç§°é…ç½®
OPENAI_MODEL=glm-4  # æˆ– glm-3-turbo

# å¯¹äº Embedding
OPENAI_EMBEDDING_MODEL=embedding-3  # ä¸æ˜¯ text-embedding-v3
```

### Q7: è®¤è¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š**
```
AuthenticationError: Incorrect API key provided
```
**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®
OPENAI_API_KEY=your_actual_key_here

# 2. ç¡®è®¤æ²¡æœ‰å¤šä½™ç©ºæ ¼
# âŒ OPENAI_API_KEY= 80e4f7bd...
# âœ… OPENAI_API_KEY=80e4f7bd...

# 3. éªŒè¯ API Key æœ‰æ•ˆæ€§
curl -X POST https://open.bigmodel.cn/api/paas/v4/chat/completions \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model":"glm-4","messages":[{"role":"user","content":"hi"}]}'
```

---

## ğŸ¤– åŠŸèƒ½ä½¿ç”¨é—®é¢˜

### Q8: Token æº¢å‡º

**é”™è¯¯ä¿¡æ¯ï¼š**
```
BadRequestError: This model's maximum context length is XXX tokens
```

**åŸå› ï¼š** å¯¹è¯å†å²è¿‡é•¿

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ–¹æ¡ˆ 1: è£å‰ªå†å²
MAX_HISTORY = 10

def trim_history(messages):
    if len(messages) > MAX_HISTORY:
        return messages[-MAX_HISTORY:]
    return messages

# æ–¹æ¡ˆ 2: åªä¿ç•™å¿…è¦æ¶ˆæ¯
def trim_messages(messages):
    system_msgs = [m for m in messages if isinstance(m, SystemMessage)]
    other_msgs = [m for m in messages if not isinstance(m, SystemMessage)]
    return system_msgs + other_msgs[-5:]

# æ–¹æ¡ˆ 3: æ‘˜è¦å†å²
from langchain.chains.summarize import load_summarize_chain

def summarize_history(messages):
    summary_chain = load_summarize_chain(llm)
    summary = summary_chain.run(messages)
    return [SystemMessage(content=f"å†å²æ‘˜è¦: {summary}")]
```

### Q9: å·¥å…·æœªè¢«è°ƒç”¨

**ç°è±¡ï¼š** å®šä¹‰äº†å·¥å…·ä½† LLM ä¸ä½¿ç”¨

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# 1. åœ¨æç¤ºè¯ä¸­æ˜ç¡®è¯´æ˜
system_prompt = """
ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š
- calculator: æ•°å­¦è®¡ç®—æ—¶å¿…é¡»ä½¿ç”¨
- get_time: æŸ¥è¯¢æ—¶é—´æ—¶å¿…é¡»ä½¿ç”¨

å½“é‡åˆ°ç›¸å…³é—®é¢˜æ—¶ï¼Œå¿…é¡»è°ƒç”¨å·¥å…·ï¼
"""

# 2. æ£€æŸ¥å·¥å…·æè¿°
@tool
def calculator(expression: str) -> str:
    """è®¡ç®—æ•°å­¦è¡¨è¾¾å¼ï¼Œç”¨æˆ·é—®æ•°å­¦é—®é¢˜æ—¶å¿…é¡»ä½¿ç”¨æ­¤å·¥å…·"""
    return eval(expression)

# 3. éªŒè¯å·¥å…·ç»‘å®š
llm_with_tools = llm.bind_tools([calculator])
print(llm_with_tools)  # æ£€æŸ¥æ˜¯å¦æ­£ç¡®ç»‘å®š
```

### Q10: æ£€ç´¢ç»“æœä¸ç›¸å…³

**ç°è±¡ï¼š** RAG è¿”å›çš„æ–‡æ¡£ä¸é—®é¢˜æ— å…³

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# 1. è°ƒæ•´åˆ†å—å¤§å°
CHUNK_SIZE = 300  # å‡å°å—å¤§å°ï¼Œæé«˜ç²¾åº¦
CHUNK_OVERLAP = 50

# 2. æ”¹è¿›åˆ†å‰²ç¬¦
separators=["\n\n##", "\n\n", "\n", "ã€‚", " ", ""]

# 3. ä½¿ç”¨é‡æ’åº
docs = vectorstore.similarity_search(question, k=10)
# å¯¹è¿™ 10 ä¸ªç»“æœé‡æ–°æ’åºï¼Œå–å‰ 3 ä¸ª

# 4. è°ƒæ•´æ£€ç´¢æ•°é‡
docs = vectorstore.similarity_search(question, k=5)  # å¢åŠ æ£€ç´¢æ•°é‡

# 5. ä½¿ç”¨æ··åˆæ£€ç´¢
from langchain.retrievers import EnsembleRetriever
# ç»“åˆå…³é”®è¯æ£€ç´¢å’Œè¯­ä¹‰æ£€ç´¢
```

### Q11: å‘é‡æ•°æ®åº“åˆ›å»ºå¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š**
```
ValueError: Chroma requires the embedding_function to be set
```

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# ç¡®ä¿æä¾› embedding å‡½æ•°
from langchain_openai import OpenAIEmbeddings

embeddings = OpenAIEmbeddings(
    model="embedding-3",
    api_key=API_KEY,
    base_url=API_BASE,
)

vectorstore = Chroma.from_documents(
    documents=splits,
    embedding=embeddings,  # å¿…é¡»æä¾›
    persist_directory="./chroma_db",
)

# åŠ è½½å·²æœ‰å‘é‡åº“æ—¶ä¹Ÿè¦æä¾›
vectorstore = Chroma(
    persist_directory="./chroma_db",
    embedding_function=embeddings,  # å¿…é¡»æä¾›
)
```

### Q12: æ•°æ®åº“é”å®š

**é”™è¯¯ä¿¡æ¯ï¼š**
```
sqlite3.OperationalError: database is locked
```

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ–¹æ¡ˆ 1: ä½¿ç”¨ WAL æ¨¡å¼
conn = sqlite3.connect("chat_history.db")
conn.execute("PRAGMA journal_mode=WAL")

# æ–¹æ¡ˆ 2: è®¾ç½®è¶…æ—¶
conn = sqlite3.connect(
    "chat_history.db",
    timeout=30  # 30 ç§’è¶…æ—¶
)

# æ–¹æ¡ˆ 3: ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨è‡ªåŠ¨å…³é—­
with sqlite3.connect("chat_history.db") as conn:
    cursor = conn.cursor()
    # æ“ä½œæ•°æ®åº“
# è‡ªåŠ¨å…³é—­è¿æ¥
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–é—®é¢˜

### Q13: å“åº”å¤ªæ…¢

**åŸå› åˆ†æï¼š**
- ç½‘ç»œå»¶è¿Ÿ
- LLM æ¨ç†æ—¶é—´é•¿
- æ–‡æ¡£æ£€ç´¢æ…¢
- å†å²æ¶ˆæ¯å¤ªå¤š

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# 1. ä½¿ç”¨æµå¼è¾“å‡º
async for chunk in llm.astream("é—®é¢˜"):
    print(chunk.content, end="", flush=True)

# 2. ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹
llm = ChatOpenAI(model="glm-3-turbo")  # æ¯” glm-4 å¿«

# 3. å‡å°‘æ£€ç´¢æ–‡æ¡£æ•°é‡
docs = vectorstore.similarity_search(question, k=2)  # ä» 3 é™åˆ° 2

# 4. è£å‰ªå†å²
messages = trim_history(messages)

# 5. ä½¿ç”¨ç¼“å­˜
from functools import lru_cache

@lru_cache(maxsize=100)
def cached_query(question):
    return agent.query(question)
```

### Q14: å†…å­˜å ç”¨è¿‡é«˜

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# 1. é™åˆ¶å‘é‡æ•°æ®åº“å¤§å°
# å®šæœŸæ¸…ç†æ—§çš„å‘é‡æ•°æ®

# 2. ä½¿ç”¨ç”Ÿæˆå™¨è€Œéåˆ—è¡¨
def stream_documents():
    for doc in documents:
        yield doc

# 3. åŠæ—¶é‡Šæ”¾èµ„æº
del large_object
import gc
gc.collect()

# 4. ä½¿ç”¨æ›´å°çš„æ¨¡å‹
llm = ChatOpenAI(model="glm-3-turbo")  # æ¯” glm-4 å°
```

### Q15: API è´¹ç”¨å¤ªé«˜

**èŠ‚çœæŠ€å·§ï¼š**
```python
# 1. å‡å°‘è¯·æ±‚æ¬¡æ•°
# ä½¿ç”¨ç¼“å­˜
@lru_cache(maxsize=100)

# 2. ä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹
llm = ChatOpenAI(model="glm-3-turbo")  # æ¯” glm-4 ä¾¿å®œ

# 3. å‡å°‘ token ä½¿ç”¨
# - ç¼©çŸ­æç¤ºè¯
# - å‡å°‘å†å²æ¶ˆæ¯
# - é™ä½æ£€ç´¢æ•°é‡

# 4. æ‰¹é‡å¤„ç†
llm.batch([q1, q2, q3])  # æ¯” 3 æ¬¡å•ç‹¬è°ƒç”¨ä¾¿å®œ

# 5. ä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼ˆç¦»çº¿åœºæ™¯ï¼‰
# ä½¿ç”¨ Ollama + langchain_ollama
```

---

## ğŸ” å…¶ä»–é—®é¢˜

### Q16: å¦‚ä½•æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**
```python
import logging

# è®¾ç½®æ—¥å¿—çº§åˆ«
logging.basicConfig(level=logging.DEBUG)

# LangChain ç‰¹å®šæ—¥å¿—
import langchain
langchain.debug = True

# ä½¿ç”¨ LangSmith è¿½è¸ª
os.environ["LANGCHAIN_TRACING_V2"] = "true"
os.environ["LANGCHAIN_API_KEY"] = "your_key"
```

### Q17: ä¸­æ–‡ä¹±ç 

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ–‡ä»¶è¯»å–æ—¶æŒ‡å®šç¼–ç 
loader = TextLoader("file.txt", encoding="utf-8")

# æ•°æ®åº“è¿æ¥æ—¶æŒ‡å®šç¼–ç 
conn = sqlite3.connect("db.db")
conn.execute("PRAGMA encoding = 'UTF-8'")

# æ‰“å°æ—¶ç¡®ä¿ç¼–ç 
print(response.content.encode("utf-8").decode("utf-8"))
```

### Q18: ImportError from tests/

**é”™è¯¯ä¿¡æ¯ï¼š**
```
ImportError: No module named 'agents.chat_agent'
```

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# åœ¨æµ‹è¯•è„šæœ¬å¼€å¤´æ·»åŠ 
import sys
import os

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from agents.chat_agent import ChatAgent
```

### Q19: å¦‚ä½•è°ƒè¯•å·¥å…·è°ƒç”¨ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ‰“å°å·¥å…·è°ƒç”¨ä¿¡æ¯
response = llm_with_tools.invoke("è®¡ç®— 123 * 456")

if hasattr(response, 'tool_calls'):
    print("å·¥å…·è°ƒç”¨:")
    for tool_call in response.tool_calls:
        print(f"  åç§°: {tool_call['name']}")
        print(f"  å‚æ•°: {tool_call['args']}")
        print(f"  ID: {tool_call['id']}")
else:
    print("æ— å·¥å…·è°ƒç”¨")
    print(f"å“åº”: {response.content}")
```

### Q20: Chroma è­¦å‘Šä¿¡æ¯

**è­¦å‘Šä¿¡æ¯ï¼š**
```
LangChainDeprecationWarning: The class `Chroma` was deprecated...
```

**è¯´æ˜ï¼š** è¿™åªæ˜¯è­¦å‘Šï¼Œä¸å½±å“ä½¿ç”¨

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ–¹æ¡ˆ 1: å¿½ç•¥è­¦å‘Šï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰
import warnings
warnings.filterwarnings("ignore", category=DeprecationWarning)

# æ–¹æ¡ˆ 2: ä½¿ç”¨æ–°åŒ…ï¼ˆå¯é€‰ï¼‰
pip install langchain-chroma

from langchain_chroma import Chroma
# å…¶ä½™ä»£ç ä¸å˜
```

---

## ğŸš¨ ç´§æ€¥æ’æŸ¥æ¸…å•

é‡åˆ°é—®é¢˜æ—¶ï¼ŒæŒ‰é¡ºåºæ£€æŸ¥ï¼š

1. **ç¯å¢ƒæ£€æŸ¥**
   ```bash
   python tests/test_setup.py
   ```

2. **é…ç½®æ£€æŸ¥**
   ```bash
   cat .env  # ç¡®è®¤ API Key å’Œ Base URL
   ```

3. **ä¾èµ–æ£€æŸ¥**
   ```bash
   pip list | grep langchain
   ```

4. **ç½‘ç»œæ£€æŸ¥**
   ```bash
   ping open.bigmodel.cn
   ```

5. **æ—¥å¿—æŸ¥çœ‹**
   ```python
   import logging
   logging.basicConfig(level=logging.DEBUG)
   ```

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šè§£å†³æ–¹æ¡ˆéƒ½æ— æ³•è§£å†³é—®é¢˜ï¼š

1. æŸ¥çœ‹ [ä»£ç é€ŸæŸ¥æ‰‹å†Œ](30-ä»£ç é€ŸæŸ¥.md)
2. é˜…è¯» [æœ€ä½³å®è·µ](20-æœ€ä½³å®è·µ.md)
3. æ£€æŸ¥ [LangChain å®˜æ–¹æ–‡æ¡£](https://python.langchain.com/)
4. åœ¨é¡¹ç›® Issues ä¸­æé—®

---

**é—®é¢˜æŒç»­æ”¶é›†ä¸­...** ğŸ“
