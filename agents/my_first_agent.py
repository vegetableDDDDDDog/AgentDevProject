import os
import sys
import time
# 1. å¯¼å…¥åŠ è½½ç¯å¢ƒå˜é‡çš„å·¥å…·
from dotenv import load_dotenv
# 2. å¯¼å…¥ LangChain çš„ OpenAI æ¥å£ (å› ä¸ºæ™ºè°±å…¼å®¹ OpenAI åè®®ï¼Œæ‰€ä»¥ç›´æ¥ç”¨è¿™ä¸ª)
from langchain_openai import ChatOpenAI
# 3. å¯¼å…¥æ¶ˆæ¯ç»“æ„ (ç³»ç»Ÿæç¤ºè¯å’Œç”¨æˆ·è¾“å…¥)
from langchain_core.messages import HumanMessage, SystemMessage

# ==========================================
# æ ¸å¿ƒæ­¥éª¤ A: åŠ è½½ .env æ–‡ä»¶
# ==========================================
# è¿™è¡Œä»£ç ä¼šæŠŠ .env é‡Œçš„å†…å®¹è¯»å–åˆ°ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ä¸­
# å¦‚æœæ²¡åŠ è¿™è¡Œï¼Œç¨‹åºå°±æ‰¾ä¸åˆ° Keyï¼Œä¼šæŠ¥é”™
load_dotenv()

# (å¯é€‰) è°ƒè¯•ä»£ç ï¼šæ£€æŸ¥ä¸€ä¸‹æ˜¯å¦çœŸçš„è¯»åˆ°äº†
# print(f"è°ƒè¯•ä¿¡æ¯ - API Key (å‰5ä½): {os.environ.get('OPENAI_API_KEY')[:5]}...")
# print(f"è°ƒè¯•ä¿¡æ¯ - API Base: {os.environ.get('OPENAI_API_BASE')}")

# ==========================================
# æ ¸å¿ƒæ­¥éª¤ B: åˆå§‹åŒ–å¤§æ¨¡å‹ (The Brain)
# ==========================================
# æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨å†™ api_key=xxxï¼ŒChatOpenAI ä¼šè‡ªåŠ¨è¯»å–ç¯å¢ƒå˜é‡
llm = ChatOpenAI(
    model="glm-4.7",  # æ™ºè°±çš„æ¨¡å‹åç§° (å¦‚æœä½ æ˜¯å…è´¹ç”¨æˆ·ï¼Œå¯ç”¨ glm-4-flash)
    temperature=0.5,  # 0.5 æ¯”è¾ƒå¹³è¡¡ï¼Œæ—¢æœ‰åˆ›é€ åŠ›åˆä¸å¤ªç¦»è°±
    max_tokens=1024,  # é™åˆ¶å›ç­”çš„é•¿åº¦
)

# ==========================================
# æ ¸å¿ƒæ­¥éª¤ C: æ„é€ å¯¹è¯å¹¶å‘é€
# ==========================================
print("ğŸš€ æ­£åœ¨å‘¼å«æ™ºè°± GLM-4.7 ...")
# æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è§¦å‘é€Ÿç‡é™åˆ¶
time.sleep(1)

messages = [
    SystemMessage(content="ä½ æ˜¯ä¸€ä¸ªèµ„æ·±çš„ Python æ¶æ„å¸ˆï¼Œæ“…é•¿ç”¨æ¯”å–»æ¥è§£é‡ŠæŠ€æœ¯æ¦‚å¿µã€‚"),
    HumanMessage(content="è¯·å‘æˆ‘è§£é‡Šä¸€ä¸‹ï¼šä¸ºä»€ä¹ˆæŠŠ API Key æ”¾åœ¨ .env æ–‡ä»¶é‡Œæ¯”å†™åœ¨ä»£ç é‡Œæ›´å¥½ï¼Ÿ")
]

try:
    # invoke å°±æ˜¯ "è°ƒç”¨/æ‰§è¡Œ" çš„æ„æ€
    response = llm.invoke(messages)

    print("\n" + "=" * 30)
    print("ğŸ¤– æ™ºè°± GLM-4.7 å›ç­”:")
    print("=" * 30)
    print(response.content)
    print("=" * 30)

except Exception as e:
    print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")
    print("å»ºè®®æ£€æŸ¥ï¼š\n1. .env æ–‡ä»¶é‡Œ Key æ˜¯å¦å¡«å¯¹\n2. æ™ºè°±çš„ API_BASE åœ°å€æ˜¯å¦æ­£ç¡®")